<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>searching for hash strings in postgres &middot; </title>
        <meta name="description" content="For one of my projects a have a database which has a rather large table consisting of just an url and a corresponding id. For performance reasons I added a md5 column which hashes the url. With this column it should be a lot faster to look up an url.
CREATE TABLE pages (  id bigint NOT NULL,  url character varying(255),  md5 character(32),  CONSTRAINT pages_pkey PRIMARY KEY (id) ) The faster lookup should mainly be possible through the shorter column length (and therefore smaller index).">
        <meta name="HandheldFriendly" content="True">
        <meta name="MobileOptimized" content="320">
        <meta name="generator" content="Hugo 0.99.1" />
        <meta name="robots" content="index,follow">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta property="og:title" content="searching for hash strings in postgres">
<meta property="og:description" content="For one of my projects a have a database which has a rather large table consisting of just an url and a corresponding id. For performance reasons I added a md5 column which hashes the url. With this column it should be a lot faster to look up an url.
CREATE TABLE pages (  id bigint NOT NULL,  url character varying(255),  md5 character(32),  CONSTRAINT pages_pkey PRIMARY KEY (id) ) The faster lookup should mainly be possible through the shorter column length (and therefore smaller index).">
<meta property="og:type" content="article">
<meta property="og:url" content="https://jens.dev/2009/09/23/searching-for-hash-strings-in-postgres.html">
        <link rel="stylesheet" href="https://jens.dev/dist/site.css">
        <link rel="stylesheet" href="https://jens.dev/dist/syntax.css">
        <link rel="icon" type="image/png" href="/favicon.png">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
        
        
        
        
        

    </head>
    <body>
        
<script type="application/javascript">
var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
var doNotTrack = (dnt == "1" || dnt == "yes");
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-5676095-8', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>

        <div id="wrapper">
            <header class="site-header">
                <div class="container">
                    <div class="site-title-wrapper">
                        
                            <h1 class="site-title">
                                <a href="https://jens.dev/">My personal blog</a>
                            </h1>
                        
                        
                            <a class="button-square" href="https://jens.dev/index.xml" aria-label="RSS"><i class="fa fa-rss" aria-hidden="true"></i></a>
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Twitter" aria-label="Twitter" href="https://twitter.com/jens_walter" rel="me" >
                                <i class="fa fa-twitter" aria-hidden="true"></i>
                            </a>
                        
                        
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Github" aria-label="Github" href="https://github.com/JensWalter" rel="me">
                                <i class="fa fa-github-alt" aria-hidden="true"></i>
                            </a>
                        
                        
                        
                        
                    </div>

                    <ul class="site-nav">
                        
    <li class="site-nav-item">
        <a href="/">Blog</a>
    </li>

    <li class="site-nav-item">
        <a href="/project.html">Projects</a>
    </li>


                    </ul>
                </div>
            </header>

            <div id="container">


<div class="container">
    <article class="post-container" itemscope="" itemtype="http://schema.org/BlogPosting">
        <header class="post-header">
    <h1 class="post-title" itemprop="name headline">searching for hash strings in postgres</h1>
    
    <p class="post-date post-line">
        <span>Published <time datetime="2009-09-23" itemprop="datePublished">Wed, Sep 23, 2009</time></span>
        <span>by</span>
        <span itemscope="" itemprop="author" itemtype="https://schema.org/Person">
            <span itemprop="name">
                <a href="#" itemprop="url" rel="author"></a>
            </span>
        </span>
    </p>
    
</header>

        <div class="post-content clearfix" itemprop="articleBody">
    

    <p>For one of my projects a have a database which has a rather large table consisting of just an url and a corresponding id. For performance reasons I added a md5 column which hashes the url. With this column it should be a lot faster to look up an url.</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#00a8c8">CREATE</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#111">pages</span>
</span></span><span style="display:flex;"><span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#111">id</span> <span style="color:#111">bigint</span> <span style="color:#00a8c8">NOT</span> <span style="color:#00a8c8">NULL</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#111">url</span> <span style="color:#111">character</span> <span style="color:#111">varying</span><span style="color:#111">(</span><span style="color:#ae81ff">255</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>  <span style="color:#111">md5</span> <span style="color:#111">character</span><span style="color:#111">(</span><span style="color:#ae81ff">32</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>  <span style="color:#00a8c8">CONSTRAINT</span> <span style="color:#111">pages_pkey</span> <span style="color:#00a8c8">PRIMARY</span> <span style="color:#00a8c8">KEY</span> <span style="color:#111">(</span><span style="color:#111">id</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span></code></pre></div><p>The faster lookup should mainly be possible through the shorter column length (and therefore smaller index). Actually I don’t know if the fixed width is good or bad here, but hashes usually don’t vary in length. After creating this table I added a B-Tree unique Index to the md5 column to enable a fast lookup.</p>
<p>After a while a noticed a rather high CPU load on lookups for this table so I tried to analyze the problem. First I tried the obvious through psql.</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#111">cloud</span><span style="color:#f92672">=#</span> <span style="color:#00a8c8">explain</span> <span style="color:#00a8c8">analyze</span> <span style="color:#00a8c8">select</span> <span style="color:#f92672">*</span> <span style="color:#00a8c8">from</span> <span style="color:#111">pages</span> <span style="color:#00a8c8">where</span> <span style="color:#111">md5</span> <span style="color:#f92672">=</span><span style="color:#d88200">&#39;abc&#39;</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>                                                     <span style="color:#111">QUERY</span> <span style="color:#111">PLAN</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">---------------------------------------------------------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> <span style="color:#00a8c8">Index</span> <span style="color:#111">Scan</span> <span style="color:#00a8c8">using</span> <span style="color:#111">i_pages_md5</span> <span style="color:#00a8c8">on</span> <span style="color:#111">pages</span>  <span style="color:#111">(</span><span style="color:#111">cost</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#111">.</span><span style="color:#ae81ff">00</span><span style="color:#111">..</span><span style="color:#ae81ff">8</span><span style="color:#111">.</span><span style="color:#ae81ff">50</span> <span style="color:#00a8c8">rows</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#111">width</span><span style="color:#f92672">=</span><span style="color:#ae81ff">166</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#111">actual</span> <span style="color:#111">time</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#111">.</span><span style="color:#ae81ff">046</span><span style="color:#111">..</span><span style="color:#ae81ff">0</span><span style="color:#111">.</span><span style="color:#ae81ff">046</span> <span style="color:#00a8c8">rows</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> <span style="color:#111">loops</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#00a8c8">Index</span> <span style="color:#111">Cond</span><span style="color:#111">:</span> <span style="color:#111">(</span><span style="color:#111">md5</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#39;abc&#39;</span><span style="color:#111">::</span><span style="color:#111">bpchar</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span> <span style="color:#111">Total</span> <span style="color:#111">runtime</span><span style="color:#111">:</span> <span style="color:#ae81ff">0</span><span style="color:#111">.</span><span style="color:#ae81ff">157</span> <span style="color:#111">ms</span>
</span></span><span style="display:flex;"><span><span style="color:#111">(</span><span style="color:#ae81ff">3</span> <span style="color:#00a8c8">rows</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>As the explain shows all works perfectly fine and lookups shouldn’t be a problem. So there had to be something different what was going on.</p>
<p>After that I tried the same select with an actual md5.</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#111">cloud</span><span style="color:#f92672">=#</span> <span style="color:#00a8c8">explain</span> <span style="color:#00a8c8">analyze</span> <span style="color:#00a8c8">select</span> <span style="color:#f92672">*</span> <span style="color:#00a8c8">from</span> <span style="color:#111">pages</span> <span style="color:#00a8c8">where</span> <span style="color:#111">md5</span> <span style="color:#f92672">=</span> <span style="color:#111">md5</span><span style="color:#111">(</span><span style="color:#d88200">&#39;abc&#39;</span><span style="color:#111">);</span>
</span></span><span style="display:flex;"><span>                                                  <span style="color:#111">QUERY</span> <span style="color:#111">PLAN</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--------------------------------------------------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> <span style="color:#111">Seq</span> <span style="color:#111">Scan</span> <span style="color:#00a8c8">on</span> <span style="color:#111">pages</span>  <span style="color:#111">(</span><span style="color:#111">cost</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#111">.</span><span style="color:#ae81ff">00</span><span style="color:#111">..</span><span style="color:#ae81ff">32017</span><span style="color:#111">.</span><span style="color:#ae81ff">63</span> <span style="color:#00a8c8">rows</span><span style="color:#f92672">=</span><span style="color:#ae81ff">3994</span> <span style="color:#111">width</span><span style="color:#f92672">=</span><span style="color:#ae81ff">166</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#111">actual</span> <span style="color:#111">time</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1203</span><span style="color:#111">.</span><span style="color:#ae81ff">699</span><span style="color:#111">..</span><span style="color:#ae81ff">1203</span><span style="color:#111">.</span><span style="color:#ae81ff">699</span> <span style="color:#00a8c8">rows</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> <span style="color:#111">loops</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#111">Filter</span><span style="color:#111">:</span> <span style="color:#111">((</span><span style="color:#111">md5</span><span style="color:#111">)::</span><span style="color:#111">text</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#39;900150983cd24fb0d6963f7d28e17f72&#39;</span><span style="color:#111">::</span><span style="color:#111">text</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span> <span style="color:#111">Total</span> <span style="color:#111">runtime</span><span style="color:#111">:</span> <span style="color:#ae81ff">1203</span><span style="color:#111">.</span><span style="color:#ae81ff">769</span> <span style="color:#111">ms</span>
</span></span><span style="display:flex;"><span><span style="color:#111">(</span><span style="color:#ae81ff">3</span> <span style="color:#00a8c8">rows</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>Now you can see the plan does change quite a lot. I have a full table scan instead of an index scan. You can also see that the query time increases nearly by factor ten thousand.</p>
<p>The reason for this dramatic change is a simple type mismatch. For whatever reason the md5 function will be evaluated to a string of the type text. To create a match with the column md5 all values had to be casted to that type. The side effect of this is that the index can no longer be used, because it is of the wrong type.</p>
<p>To solve this I just had to cast the result of the md5 function back to something that is compatible with the index type. In my case I used a fixed width character field which is represented in the database as bpchar (blank padded character). So after modifying the query to the following I was back on index usage.</p>
<pre tabindex="0"><code class="language-sqlcloud=#" data-lang="sqlcloud=#">                                                     QUERY PLAN
---------------------------------------------------------------------------------------------------------------------
 Index Scan using i_pages_md5 on pages  (cost=0.00..8.50 rows=1 width=166) (actual time=0.141..0.141 rows=0 loops=1)
   Index Cond: (md5 = &#39;900150983cd24fb0d6963f7d28e17f72&#39;::bpchar)
 Total runtime: 0.199 ms
(3 rows)
</code></pre>
</div>

        <footer class="post-footer clearfix">
        <p class="post-tags">
            <span>Tagged:</span>
                <a href="/tags/performance.html">performance</a>, 
                <a href="/tags/postgres.html">postgres</a>
        </p>
    <div class="share">
    </div>
</footer>

        
    </article>
</div>

            </div>
        </div>

        <footer class="footer">
            <div class="container">
                <div class="site-title-wrapper">
                    <h1 class="site-title">
                        <a href="https://jens.dev/">My personal blog</a>
                    </h1>
                    <a class="button-square button-jump-top js-jump-top" href="#" aria-label="Back to Top">
                        <i class="fa fa-angle-up" aria-hidden="true"></i>
                    </a>
                </div>

                <p class="footer-copyright">
                    <span>&copy; 2022 / Powered by <a href="https://gohugo.io/">Hugo</a></span>
                </p>
                <p class="footer-copyright">
                    <span><a href="https://github.com/roryg/ghostwriter">Ghostwriter theme</a> By <a href="http://jollygoodthemes.com">JollyGoodThemes</a></span>
                    <span>/ <a href="https://github.com/jbub/ghostwriter">Ported</a> to Hugo By <a href="https://github.com/jbub">jbub</a></span>
                </p>
            </div>
        </footer>

        <script src="https://jens.dev/js/jquery-1.11.3.min.js"></script>
        <script src="https://jens.dev/js/jquery.fitvids.js"></script>
        <script src="https://jens.dev/js/scripts.js"></script>
    </body>
</html>

