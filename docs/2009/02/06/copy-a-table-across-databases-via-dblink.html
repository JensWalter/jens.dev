<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>copy a table across databases via dblink &middot; </title>
        <meta name="description" content="Recently I ran into the situation that I needed to copy a large subset of data from one database to another. Normally I would say, make a dump and then re-import the data into the new schema. But this solution has some serious drawbacks. First you have to copy the complete database. Second you have to maintain the structure of the data. A third problem could be that you have to copy the complete dump to the target location (in case it is not the same machine and your database is a bit larger e.">
        <meta name="HandheldFriendly" content="True">
        <meta name="MobileOptimized" content="320">
        <meta name="generator" content="Hugo 0.110.0">
        <meta name="robots" content="index,follow">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta property="og:title" content="copy a table across databases via dblink">
<meta property="og:description" content="Recently I ran into the situation that I needed to copy a large subset of data from one database to another. Normally I would say, make a dump and then re-import the data into the new schema. But this solution has some serious drawbacks. First you have to copy the complete database. Second you have to maintain the structure of the data. A third problem could be that you have to copy the complete dump to the target location (in case it is not the same machine and your database is a bit larger e.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://jens.dev/2009/02/06/copy-a-table-across-databases-via-dblink.html">
        <link rel="stylesheet" href="https://jens.dev/dist/site.css">
        <link rel="stylesheet" href="https://jens.dev/dist/syntax.css">
        <link rel="icon" type="image/png" href="/favicon.png">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
        
        
        
        
        

    </head>
    <body>
        
<script type="application/javascript">
var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
var doNotTrack = (dnt == "1" || dnt == "yes");
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-5676095-8', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>

        <div id="wrapper">
            <header class="site-header">
                <div class="container">
                    <div class="site-title-wrapper">
                        
                            <h1 class="site-title">
                                <a href="https://jens.dev/">My personal blog</a>
                            </h1>
                        
                        
                            <a class="button-square" href="https://jens.dev/index.xml" aria-label="RSS"><i class="fa fa-rss" aria-hidden="true"></i></a>
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Twitter" aria-label="Twitter" href="https://twitter.com/jens_walter" rel="me" >
                                <i class="fa fa-twitter" aria-hidden="true"></i>
                            </a>
                        
                        
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Github" aria-label="Github" href="https://github.com/JensWalter" rel="me">
                                <i class="fa fa-github-alt" aria-hidden="true"></i>
                            </a>
                        
                        
                        
                        
                    </div>

                    <ul class="site-nav">
                        
    <li class="site-nav-item">
        <a href="/">Blog</a>
    </li>

    <li class="site-nav-item">
        <a href="/project.html">Projects</a>
    </li>


                    </ul>
                </div>
            </header>

            <div id="container">


<div class="container">
    <article class="post-container" itemscope="" itemtype="http://schema.org/BlogPosting">
        <header class="post-header">
    <h1 class="post-title" itemprop="name headline">copy a table across databases via dblink</h1>
    
    <p class="post-date post-line">
        <span>Published <time datetime="2009-02-06" itemprop="datePublished">Fri, Feb 6, 2009</time></span>
        <span>by</span>
        <span itemscope="" itemprop="author" itemtype="https://schema.org/Person">
            <span itemprop="name">
                <a href="#" itemprop="url" rel="author"></a>
            </span>
        </span>
    </p>
    
</header>

        <div class="post-content clearfix" itemprop="articleBody">
    

    <p>Recently I ran into the situation that I needed to copy a large subset of data from one database to another. Normally I would say, make a dump and then re-import the data into the new schema. But this solution has some serious drawbacks. First you have to copy the complete database. Second you have to maintain the structure of the data. A third problem could be that you have to copy the complete dump to the target location (in case it is not the same machine and your database is a bit larger e.g. some gigabyte). Having these drawbacks in mind I started searching for an alternative solution for my problem.</p>
<p>Here some facts to render my situation more precisely.</p>
<ul>
<li>database containing multiple tables</li>
<li>only one has relevant data</li>
<li>only the subset of 1 month is needed</li>
</ul>
<p><strong>ddl for the original table:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#00a8c8">CREATE</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#111">realtime</span>
</span></span><span style="display:flex;"><span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span><span style="color:#111">name</span> <span style="color:#111">varchar</span><span style="color:#111">(</span><span style="color:#ae81ff">10</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span><span style="color:#111">date</span> <span style="color:#00a8c8">timestamp</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span><span style="color:#111">bid</span> <span style="color:#111">numeric</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span><span style="color:#111">ask</span> <span style="color:#111">numeric</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span></code></pre></div><p><strong>ddl for the target table:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#00a8c8">CREATE</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#111">realtime</span>
</span></span><span style="display:flex;"><span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span><span style="color:#111">symbol</span> <span style="color:#111">varchar</span><span style="color:#111">(</span><span style="color:#ae81ff">10</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span><span style="color:#111">date</span> <span style="color:#00a8c8">timestamp</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span><span style="color:#111">price</span> <span style="color:#111">numeric</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span><span style="color:#d88200">&#34;day&#34;</span> <span style="color:#111">char</span><span style="color:#111">(</span><span style="color:#ae81ff">5</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">max</span> <span style="color:#111">numeric</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">avg</span> <span style="color:#111">numeric</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span><span style="color:#111">atr</span> <span style="color:#111">numeric</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span></code></pre></div><p><strong>here the mapping:</strong></p>
<p>realtime.name -&gt; realtime.symbol</p>
<p>realtime.date -&gt; realtime.date</p>
<p>(realtime.bid + realtime.ask) /2 -&gt; realtime.price</p>
<p>-&gt; other columns filled by trigger</p>
<p>To get this task done I decided to use a dblink between those two database instances (<a href="http://www.postgresql.org/docs/current/static/contrib-dblink.html">how-to here</a>).</p>
<p>So here is the select I used to transfer the month January to the new db:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#00a8c8">insert</span> <span style="color:#00a8c8">into</span> <span style="color:#111">realtime</span> <span style="color:#111">(</span><span style="color:#111">symbol</span><span style="color:#111">,</span><span style="color:#111">date</span><span style="color:#111">,</span><span style="color:#111">price</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">select</span> <span style="color:#f92672">*</span> <span style="color:#00a8c8">from</span> <span style="color:#111">dblink</span><span style="color:#111">(</span><span style="color:#d88200">&#39;dbname=stocks&#39;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>              <span style="color:#d88200">&#39;select name,date,(bid+ask)/2 as price
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">              from realtime
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">              where date &gt; to_date(&#39;&#39;20081231&#39;&#39;,&#39;&#39;yyyyMMDD&#39;&#39;) and date &amp;lt; to_date(&#39;&#39;20090201&#39;&#39;,&#39;&#39;yyyyMMDD&#39;&#39;)&#39;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>         <span style="color:#00a8c8">as</span> <span style="color:#111">t1</span> <span style="color:#111">(</span><span style="color:#111">name</span> <span style="color:#111">character</span> <span style="color:#111">varying</span><span style="color:#111">,</span><span style="color:#111">date</span> <span style="color:#00a8c8">timestamp</span><span style="color:#111">,</span><span style="color:#111">price</span> <span style="color:#111">numeric</span><span style="color:#111">);</span>
</span></span></code></pre></div><p>As you can see this approach is pretty straight forward. You basically write an insert statement for the new table and use a dblink as source. In the dblink definition you can apply any given sql criteria.</p>
<p>One real drawback has this solution, because of the mode of operation of the dblink approach it is pretty slow. Here is what the postgres documentation has to say about this:</p>
<p>dblink fetches the entire remote query result before returning any of it to the local system. If the query is expected to return a large number of rows, it’s better to open it as a cursor with dblink_open and then fetch a manageable number of rows at a time.For me the performance was ok because I just copied several hundred megabytes.</p>

</div>

        <footer class="post-footer clearfix">
        <p class="post-tags">
            <span>Tagged:</span>
                <a href="/tags/dblink.html">dblink</a>, 
                <a href="/tags/postgres.html">postgres</a>
        </p>
    <div class="share">
    </div>
</footer>

        
    </article>
</div>

            </div>
        </div>

        <footer class="footer">
            <div class="container">
                <div class="site-title-wrapper">
                    <h1 class="site-title">
                        <a href="https://jens.dev/">My personal blog</a>
                    </h1>
                    <a class="button-square button-jump-top js-jump-top" href="#" aria-label="Back to Top">
                        <i class="fa fa-angle-up" aria-hidden="true"></i>
                    </a>
                </div>

                <p class="footer-copyright">
                    <span>&copy; 2022 / Powered by <a href="https://gohugo.io/">Hugo</a></span>
                </p>
                <p class="footer-copyright">
                    <span><a href="https://github.com/roryg/ghostwriter">Ghostwriter theme</a> By <a href="http://jollygoodthemes.com">JollyGoodThemes</a></span>
                    <span>/ <a href="https://github.com/jbub/ghostwriter">Ported</a> to Hugo By <a href="https://github.com/jbub">jbub</a></span>
                </p>
            </div>
        </footer>

        <script src="https://jens.dev/js/jquery-1.11.3.min.js"></script>
        <script src="https://jens.dev/js/jquery.fitvids.js"></script>
        <script src="https://jens.dev/js/scripts.js"></script>
    </body>
</html>

