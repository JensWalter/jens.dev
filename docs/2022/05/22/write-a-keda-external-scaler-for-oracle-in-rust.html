<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Write a KEDA external Scaler for Oracle in Rust &middot; </title>
        <meta name="description" content="Introduction KEDA (Kubernetes Event-driven Autoscaling) is as the name says a scaling framwork for kubernetes. This frameword can scale based in internal scalers as well as externally defined scalers. Here I wate to write a Rust based scaler, which implements ths gRPS external scaler interface.
Overview The proto definition gives the following interface.
service ExternalScaler { rpc IsActive(ScaledObjectRef) returns (IsActiveResponse) {} rpc StreamIsActive(ScaledObjectRef) returns (stream IsActiveResponse) {} rpc GetMetricSpec(ScaledObjectRef) returns (GetMetricSpecResponse) {} rpc GetMetrics(GetMetricsRequest) returns (GetMetricsResponse) {} } For now I am ignoring the option for the streaming service.">
        <meta name="HandheldFriendly" content="True">
        <meta name="MobileOptimized" content="320">
        <meta name="generator" content="Hugo 0.99.1" />
        <meta name="robots" content="index,follow">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta property="og:title" content="Write a KEDA external Scaler for Oracle in Rust">
<meta property="og:description" content="Introduction KEDA (Kubernetes Event-driven Autoscaling) is as the name says a scaling framwork for kubernetes. This frameword can scale based in internal scalers as well as externally defined scalers. Here I wate to write a Rust based scaler, which implements ths gRPS external scaler interface.
Overview The proto definition gives the following interface.
service ExternalScaler { rpc IsActive(ScaledObjectRef) returns (IsActiveResponse) {} rpc StreamIsActive(ScaledObjectRef) returns (stream IsActiveResponse) {} rpc GetMetricSpec(ScaledObjectRef) returns (GetMetricSpecResponse) {} rpc GetMetrics(GetMetricsRequest) returns (GetMetricsResponse) {} } For now I am ignoring the option for the streaming service.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://jens.dev/2022/05/22/write-a-keda-external-scaler-for-oracle-in-rust.html">
        <link rel="stylesheet" href="https://jens.dev/dist/site.css">
        <link rel="stylesheet" href="https://jens.dev/dist/syntax.css">
        <link rel="icon" type="image/png" href="/favicon.png">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
        
        
        
        
        

    </head>
    <body>
        
<script type="application/javascript">
var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
var doNotTrack = (dnt == "1" || dnt == "yes");
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-5676095-8', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>

        <div id="wrapper">
            <header class="site-header">
                <div class="container">
                    <div class="site-title-wrapper">
                        
                            <h1 class="site-title">
                                <a href="https://jens.dev/">My personal blog</a>
                            </h1>
                        
                        
                            <a class="button-square" href="https://jens.dev/index.xml" aria-label="RSS"><i class="fa fa-rss" aria-hidden="true"></i></a>
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Twitter" aria-label="Twitter" href="https://twitter.com/jens_walter" rel="me" >
                                <i class="fa fa-twitter" aria-hidden="true"></i>
                            </a>
                        
                        
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Github" aria-label="Github" href="https://github.com/JensWalter" rel="me">
                                <i class="fa fa-github-alt" aria-hidden="true"></i>
                            </a>
                        
                        
                        
                        
                    </div>

                    <ul class="site-nav">
                        
    <li class="site-nav-item">
        <a href="/">Blog</a>
    </li>

    <li class="site-nav-item">
        <a href="/project.html">Projects</a>
    </li>


                    </ul>
                </div>
            </header>

            <div id="container">


<div class="container">
    <article class="post-container" itemscope="" itemtype="http://schema.org/BlogPosting">
        <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Write a KEDA external Scaler for Oracle in Rust</h1>
    
    <p class="post-date post-line">
        <span>Published <time datetime="2022-05-22" itemprop="datePublished">Sun, May 22, 2022</time></span>
        <span>by</span>
        <span itemscope="" itemprop="author" itemtype="https://schema.org/Person">
            <span itemprop="name">
                <a href="#" itemprop="url" rel="author"></a>
            </span>
        </span>
    </p>
    
</header>

        <div class="post-content clearfix" itemprop="articleBody">
    

    <h2 id="introduction">Introduction</h2>
<p><a href="https://keda.sh/">KEDA</a> (Kubernetes Event-driven Autoscaling) is as the name says a scaling framwork for kubernetes. This frameword can scale based in internal scalers as well as externally defined scalers. Here I wate to write a Rust based scaler, which implements ths gRPS <a href="https://keda.sh/docs/2.7/scalers/external/">external scaler interface</a>.</p>
<h2 id="overview">Overview</h2>
<p>The proto definition gives the following interface.</p>
<pre tabindex="0"><code>service ExternalScaler {
    rpc IsActive(ScaledObjectRef) returns (IsActiveResponse) {}
    rpc StreamIsActive(ScaledObjectRef) returns (stream IsActiveResponse) {}
    rpc GetMetricSpec(ScaledObjectRef) returns (GetMetricSpecResponse) {}
    rpc GetMetrics(GetMetricsRequest) returns (GetMetricsResponse) {}
}
</code></pre><p>For now I am ignoring the option for the streaming service. That leaves me with the isActive and GetMetrics invocations.</p>
<p>So to re-iterate:</p>
<ul>
<li>isActive: returns true if the target should be scaled up, false if it should be scaled down.</li>
<li>GetMetrics: returns the value, that the scaler bases its decision on the desired number of replicas.</li>
</ul>
<h2 id="setup">Setup</h2>
<h2 id="isactive">IsActive</h2>
<p>The <code>isActive</code>-call is used to determine if the scaler should scale up or down. So it must contain the logic to determine this. The first thing to figure out here is, how to get any parameters into that call.</p>
<p>From the keda docs, the following sample describes the usage of the external scaler.</p>
<pre tabindex="0"><code>apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: scaledobject-name
  namespace: scaledobject-namespace
spec:
  scaleTargetRef:
    name: deployment-name
  triggers:
    - type: external-push
      metadata:
        scalerAddress: service-address.svc.local:9090
        key1: value1
        key2: value2
</code></pre><p>So in my case this qould look like this.</p>
<pre tabindex="0"><code>apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: scale-on-bookings
spec:
  scaleTargetRef:
    name: booking-svc
  triggers:
    - type: external-push
      metadata:
        scalerAddress: db.svc:10000
        query: select * from bookings where status = &#39;confirmed&#39;
</code></pre><p>The first thing to worry about the <code>isActive</code> call is actually, what is handed over and how can I access the data. So again, I looked it up in the proto definition of the service. It seems there is a generic name/value section at the end of the call which should hand over any custom defined parameters from the yaml to the external scaler.</p>
<pre tabindex="0"><code>message ScaledObjectRef {
    string name = 1;
    string namespace = 2;
    map&lt;string, string&gt; scalerMetadata = 3;
}
</code></pre><p>No that we have a query, we can call the database with that and retrieve the count.</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00a8c8">async</span> <span style="color:#00a8c8">fn</span> <span style="color:#75af00">run_query</span><span style="color:#111">(</span><span style="color:#111">query</span>: <span style="color:#00a8c8">&amp;</span><span style="color:#00a8c8">str</span><span style="color:#111">)</span> -&gt; <span style="color:#00a8c8">i64</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">match</span> <span style="color:#111">DB_CONNECTION</span><span style="color:#111">.</span><span style="color:#111">lock</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">Ok</span><span style="color:#111">(</span><span style="color:#111">conn</span><span style="color:#111">)</span> <span style="color:#f92672">=&gt;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">let</span> <span style="color:#111">rows</span> <span style="color:#f92672">=</span> <span style="color:#111">conn</span><span style="color:#111">.</span><span style="color:#111">query</span><span style="color:#111">(</span><span style="color:#111">query</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#111">[]).</span><span style="color:#111">unwrap</span><span style="color:#111">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">let</span> <span style="color:#00a8c8">mut</span> <span style="color:#111">metric_value</span>: <span style="color:#00a8c8">i64</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">let</span> <span style="color:#00a8c8">mut</span> <span style="color:#111">counter</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">for</span> <span style="color:#111">row_result</span> <span style="color:#00a8c8">in</span> <span style="color:#111">rows</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">let</span> <span style="color:#111">row</span> <span style="color:#f92672">=</span> <span style="color:#111">row_result</span><span style="color:#111">.</span><span style="color:#111">unwrap</span><span style="color:#111">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">counter</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">if</span> <span style="color:#111">counter</span><span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#00a8c8">let</span> <span style="color:#111">first_column</span>: <span style="color:#111">Result</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">i64</span><span style="color:#111">,</span> <span style="color:#111">_</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span> <span style="color:#111">row</span><span style="color:#111">.</span><span style="color:#111">get</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#00a8c8">match</span> <span style="color:#111">first_column</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#111">Ok</span><span style="color:#111">(</span><span style="color:#111">value</span><span style="color:#111">)</span> <span style="color:#f92672">=&gt;</span> <span style="color:#111">metric_value</span> <span style="color:#f92672">=</span> <span style="color:#111">value</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#111">Err</span><span style="color:#111">(</span><span style="color:#111">_</span><span style="color:#111">)</span> <span style="color:#f92672">=&gt;</span> <span style="color:#111">metric_value</span> <span style="color:#f92672">=</span> <span style="color:#111">counter</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">}</span><span style="color:#00a8c8">else</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#111">metric_value</span> <span style="color:#f92672">=</span> <span style="color:#111">counter</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#111">metric_value</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">Err</span><span style="color:#111">(</span><span style="color:#111">_e</span><span style="color:#111">)</span> <span style="color:#f92672">=&gt;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">log</span>::<span style="color:#111">error</span><span style="color:#f92672">!</span><span style="color:#111">(</span><span style="color:#d88200">&#34;poison error, restarting...&#34;</span><span style="color:#111">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">std</span>::<span style="color:#111">process</span>::<span style="color:#111">exit</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>The only thing left to do here is to patch this call into the isActive routine.</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>  <span style="color:#00a8c8">async</span> <span style="color:#00a8c8">fn</span> <span style="color:#75af00">is_active</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&amp;</span><span style="color:#111">self</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#111">request</span>: <span style="color:#75af00">Request</span><span style="color:#f92672">&lt;</span><span style="color:#111">ScaledObjectRef</span><span style="color:#f92672">&gt;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#111">)</span> -&gt; <span style="color:#111">Result</span><span style="color:#f92672">&lt;</span><span style="color:#111">Response</span><span style="color:#f92672">&lt;</span><span style="color:#111">IsActiveResponse</span><span style="color:#f92672">&gt;</span><span style="color:#111">,</span> <span style="color:#111">Status</span><span style="color:#f92672">&gt;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#00a8c8">let</span> <span style="color:#111">inner</span> <span style="color:#f92672">=</span> <span style="color:#111">request</span><span style="color:#111">.</span><span style="color:#111">into_inner</span><span style="color:#111">();</span>
</span></span><span style="display:flex;"><span>      <span style="color:#00a8c8">let</span> <span style="color:#111">metadata</span> <span style="color:#f92672">=</span> <span style="color:#111">inner</span><span style="color:#111">.</span><span style="color:#111">scaler_metadata</span><span style="color:#111">.</span><span style="color:#111">clone</span><span style="color:#111">();</span>
</span></span><span style="display:flex;"><span>      <span style="color:#00a8c8">let</span> <span style="color:#00a8c8">mut</span> <span style="color:#111">metric_value</span>:<span style="color:#00a8c8">i64</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#00a8c8">if</span> <span style="color:#111">metadata</span><span style="color:#111">.</span><span style="color:#111">contains_key</span><span style="color:#111">(</span><span style="color:#d88200">&#34;query&#34;</span><span style="color:#111">){</span>
</span></span><span style="display:flex;"><span>          <span style="color:#00a8c8">let</span> <span style="color:#111">query</span> <span style="color:#f92672">=</span> <span style="color:#111">metadata</span><span style="color:#111">.</span><span style="color:#111">get</span><span style="color:#111">(</span><span style="color:#d88200">&#34;query&#34;</span><span style="color:#111">).</span><span style="color:#111">unwrap</span><span style="color:#111">();</span>
</span></span><span style="display:flex;"><span>          <span style="color:#111">metric_value</span> <span style="color:#f92672">=</span> <span style="color:#111">run_query</span><span style="color:#111">(</span><span style="color:#111">query</span><span style="color:#111">).</span><span style="color:#00a8c8">await</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#111">log</span>::<span style="color:#111">debug</span><span style="color:#f92672">!</span><span style="color:#111">(</span><span style="color:#d88200">&#34;{metric_value} from query \&#34;{query}\&#34;&#34;</span><span style="color:#111">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#111">}</span><span style="color:#00a8c8">else</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#111">log</span>::<span style="color:#111">warn</span><span style="color:#f92672">!</span><span style="color:#111">(</span><span style="color:#d88200">&#34;no query found in metadata: {:?}&#34;</span><span style="color:#111">,</span> <span style="color:#111">metadata</span><span style="color:#111">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#00a8c8">if</span> <span style="color:#111">metric_value</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#111">Ok</span><span style="color:#111">(</span><span style="color:#111">Response</span>::<span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#111">IsActiveResponse</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>              <span style="color:#111">result</span>: <span style="color:#75af00">true</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>          <span style="color:#111">}))</span>    
</span></span><span style="display:flex;"><span>      <span style="color:#111">}</span><span style="color:#00a8c8">else</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#111">Ok</span><span style="color:#111">(</span><span style="color:#111">Response</span>::<span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#111">IsActiveResponse</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>              <span style="color:#111">result</span>: <span style="color:#75af00">false</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>          <span style="color:#111">}))</span>    
</span></span><span style="display:flex;"><span>      <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="getmetrics">GetMetrics</h2>
<p>Similar to the <code>isActive</code>, the <code>GetMetrics</code> call is used to determine the desired number of replicas. So the only change I needed to implement here was return the actual value instead of the true/false for scaling.</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#00a8c8">async</span> <span style="color:#00a8c8">fn</span> <span style="color:#75af00">get_metrics</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&amp;</span><span style="color:#111">self</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">request</span>: <span style="color:#75af00">Request</span><span style="color:#f92672">&lt;</span><span style="color:#111">GetMetricsRequest</span><span style="color:#f92672">&gt;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span> -&gt; <span style="color:#111">Result</span><span style="color:#f92672">&lt;</span><span style="color:#111">Response</span><span style="color:#f92672">&lt;</span><span style="color:#111">GetMetricsResponse</span><span style="color:#f92672">&gt;</span><span style="color:#111">,</span> <span style="color:#111">Status</span><span style="color:#f92672">&gt;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">let</span> <span style="color:#111">inner</span> <span style="color:#f92672">=</span> <span style="color:#111">request</span><span style="color:#111">.</span><span style="color:#111">into_inner</span><span style="color:#111">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">let</span> <span style="color:#111">name</span> <span style="color:#f92672">=</span> <span style="color:#111">inner</span><span style="color:#111">.</span><span style="color:#111">metric_name</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">let</span> <span style="color:#111">scaled_object</span> <span style="color:#f92672">=</span> <span style="color:#111">inner</span><span style="color:#111">.</span><span style="color:#111">scaled_object_ref</span><span style="color:#111">.</span><span style="color:#111">unwrap</span><span style="color:#111">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">let</span> <span style="color:#111">metadata</span> <span style="color:#f92672">=</span> <span style="color:#111">scaled_object</span><span style="color:#111">.</span><span style="color:#111">scaler_metadata</span><span style="color:#111">.</span><span style="color:#111">clone</span><span style="color:#111">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">log</span>::<span style="color:#111">debug</span><span style="color:#f92672">!</span><span style="color:#111">(</span><span style="color:#d88200">&#34;{name}: {:?}&#34;</span><span style="color:#111">,</span> <span style="color:#111">metadata</span><span style="color:#111">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">metadata</span><span style="color:#111">.</span><span style="color:#111">contains_key</span><span style="color:#111">(</span><span style="color:#d88200">&#34;query&#34;</span><span style="color:#111">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">let</span> <span style="color:#111">query</span> <span style="color:#f92672">=</span> <span style="color:#111">metadata</span><span style="color:#111">.</span><span style="color:#111">get</span><span style="color:#111">(</span><span style="color:#d88200">&#34;query&#34;</span><span style="color:#111">).</span><span style="color:#111">unwrap</span><span style="color:#111">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">let</span> <span style="color:#111">metric_value</span> <span style="color:#f92672">=</span> <span style="color:#111">run_query</span><span style="color:#111">(</span><span style="color:#111">query</span><span style="color:#111">).</span><span style="color:#00a8c8">await</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">log</span>::<span style="color:#111">debug</span><span style="color:#f92672">!</span><span style="color:#111">(</span><span style="color:#d88200">&#34;{metric_value} from query \&#34;{query}\&#34;&#34;</span><span style="color:#111">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#111">Ok</span><span style="color:#111">(</span><span style="color:#111">Response</span>::<span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#111">GetMetricsResponse</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">metric_values</span>: <span style="color:#75af00">vec</span><span style="color:#f92672">!</span><span style="color:#111">[</span><span style="color:#111">MetricValue</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">metric_name</span>: <span style="color:#75af00">name</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">metric_value</span>: <span style="color:#75af00">metric_value</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}));</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span><span style="color:#00a8c8">else</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">log</span>::<span style="color:#111">warn</span><span style="color:#f92672">!</span><span style="color:#111">(</span><span style="color:#d88200">&#34;no query found in metadata: {:?}&#34;</span><span style="color:#111">,</span> <span style="color:#111">scaled_object</span><span style="color:#111">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">Ok</span><span style="color:#111">(</span><span style="color:#111">Response</span>::<span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#111">GetMetricsResponse</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">metric_values</span>: <span style="color:#75af00">vec</span><span style="color:#f92672">!</span><span style="color:#111">[</span><span style="color:#111">MetricValue</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">metric_name</span>: <span style="color:#75af00">name</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">metric_value</span>: <span style="color:#ae81ff">0</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="finishing-up">Finishing up</h2>
<p>The complete source code can be downloaded from the following github repo <a href="https://github.com/apimeister/keda-oracle-scaler">keda-oracle-scaler</a>.</p>

</div>

        <footer class="post-footer clearfix">
        <p class="post-tags">
            <span>Tagged:</span>
                <a href="/tags/kubernetes.html">kubernetes</a>, 
                <a href="/tags/rust.html">rust</a>, 
                <a href="/tags/keda.html">keda</a>
        </p>
    <div class="share">
    </div>
</footer>

        
    </article>
</div>

            </div>
        </div>

        <footer class="footer">
            <div class="container">
                <div class="site-title-wrapper">
                    <h1 class="site-title">
                        <a href="https://jens.dev/">My personal blog</a>
                    </h1>
                    <a class="button-square button-jump-top js-jump-top" href="#" aria-label="Back to Top">
                        <i class="fa fa-angle-up" aria-hidden="true"></i>
                    </a>
                </div>

                <p class="footer-copyright">
                    <span>&copy; 2022 / Powered by <a href="https://gohugo.io/">Hugo</a></span>
                </p>
                <p class="footer-copyright">
                    <span><a href="https://github.com/roryg/ghostwriter">Ghostwriter theme</a> By <a href="http://jollygoodthemes.com">JollyGoodThemes</a></span>
                    <span>/ <a href="https://github.com/jbub/ghostwriter">Ported</a> to Hugo By <a href="https://github.com/jbub">jbub</a></span>
                </p>
            </div>
        </footer>

        <script src="https://jens.dev/js/jquery-1.11.3.min.js"></script>
        <script src="https://jens.dev/js/jquery.fitvids.js"></script>
        <script src="https://jens.dev/js/scripts.js"></script>
    </body>
</html>

