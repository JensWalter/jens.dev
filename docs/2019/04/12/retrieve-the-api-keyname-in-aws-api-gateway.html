<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Retrieve the API key name in AWS API Gateway &middot; </title>
        <meta name="description" content="The AWS API-Gateway does support authentication through API Key. It is a very convenient feature to have, especially since other functionality such a throttling and request quotas also come through that feature.
That is all good, as long as all your required functionality is provided by AWS. But what I needed was business-like Dashboard which provides insight into how my API was used by different clients.
Since all clients are identified by API Key, I hoped for some mechanism within API-Gateway to provide information such as key name to my Lambda implementation.">
        <meta name="HandheldFriendly" content="True">
        <meta name="MobileOptimized" content="320">
        <meta name="generator" content="Hugo 0.80.0" />
        <meta name="robots" content="index,follow">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta property="og:title" content="Retrieve the API key name in AWS API Gateway">
<meta property="og:description" content="The AWS API-Gateway does support authentication through API Key. It is a very convenient feature to have, especially since other functionality such a throttling and request quotas also come through that feature.
That is all good, as long as all your required functionality is provided by AWS. But what I needed was business-like Dashboard which provides insight into how my API was used by different clients.
Since all clients are identified by API Key, I hoped for some mechanism within API-Gateway to provide information such as key name to my Lambda implementation.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://jens.dev/2019/04/12/retrieve-the-api-keyname-in-aws-api-gateway.html">
        <link rel="stylesheet" href="https://jens.dev/dist/site.css">
        <link rel="stylesheet" href="https://jens.dev/dist/syntax.css">
        <link rel="icon" type="image/png" href="/favicon.png">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
        
        
        
        
        

    </head>
    <body>
        
<script type="application/javascript">
var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
var doNotTrack = (dnt == "1" || dnt == "yes");
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-5676095-8', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>


        <div id="wrapper">
            <header class="site-header">
                <div class="container">
                    <div class="site-title-wrapper">
                        
                            <h1 class="site-title">
                                <a href="https://jens.dev/">My personal blog</a>
                            </h1>
                        
                        
                            <a class="button-square" href="https://jens.dev/index.xml" aria-label="RSS"><i class="fa fa-rss" aria-hidden="true"></i></a>
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Twitter" aria-label="Twitter" href="https://twitter.com/jens_walter" rel="me" >
                                <i class="fa fa-twitter" aria-hidden="true"></i>
                            </a>
                        
                        
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Github" aria-label="Github" href="https://github.com/JensWalter" rel="me">
                                <i class="fa fa-github-alt" aria-hidden="true"></i>
                            </a>
                        
                        
                        
                        
                    </div>

                    <ul class="site-nav">
                        
    <li class="site-nav-item">
        <a href="/">Blog</a>
    </li>

    <li class="site-nav-item">
        <a href="/project.html">Projects</a>
    </li>


                    </ul>
                </div>
            </header>

            <div id="container">


<div class="container">
    <article class="post-container" itemscope="" itemtype="http://schema.org/BlogPosting">
        <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Retrieve the API key name in AWS API Gateway</h1>
    
    <p class="post-date post-line">
        <span>Published <time datetime="2019-04-12" itemprop="datePublished">Fri, Apr 12, 2019</time></span>
        <span>by</span>
        <span itemscope="" itemprop="author" itemtype="https://schema.org/Person">
            <span itemprop="name">
                <a href="#" itemprop="url" rel="author"></a>
            </span>
        </span>
    </p>
    
</header>

        <div class="post-content clearfix" itemprop="articleBody">
    

    <p>The AWS API-Gateway does support authentication through API Key. It is a very convenient feature to have, especially since other functionality such a throttling and request quotas also come through that feature.</p>
<p>That is all good, as long as all your required functionality is provided by AWS. But what I needed was business-like Dashboard which provides insight into how my API was used by different clients.</p>
<p>Since all clients are identified by API Key, I hoped for some mechanism within API-Gateway to provide information such as key name to my Lambda implementation. Sadly something like this is currently not possible.</p>
<p>So I started to implement this in my lambda. First I had to query all API-Keys since the SDK does not allow to search for keys by value.</p>
<p>After retrieving all keys, I could just loop through the values and find the corresponding key name.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#00a8c8">var</span> <span style="color:#75af00">apiKey</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;abc123&#34;</span><span style="color:#111">;</span>
  
<span style="color:#75715e">// get all api key
</span><span style="color:#75715e"></span><span style="color:#00a8c8">var</span> <span style="color:#75af00">params</span> <span style="color:#f92672">=</span> <span style="color:#111">{</span> <span style="color:#75af00">includeValues</span><span style="color:#f92672">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#75af00">limit</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">500</span><span style="color:#111">};</span>
<span style="color:#00a8c8">let</span> <span style="color:#75af00">keys</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">await</span> <span style="color:#75af00">APIGATEWAY</span><span style="color:#111">.</span><span style="color:#75af00">getApiKeys</span><span style="color:#111">(</span><span style="color:#75af00">params</span><span style="color:#111">).</span><span style="color:#75af00">promise</span><span style="color:#111">();</span>
<span style="color:#00a8c8">for</span><span style="color:#111">(</span><span style="color:#00a8c8">let</span> <span style="color:#75af00">idx</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#111">;</span><span style="color:#75af00">idx</span><span style="color:#f92672">&lt;</span><span style="color:#75af00">keys</span><span style="color:#111">.</span><span style="color:#75af00">items</span><span style="color:#111">.</span><span style="color:#75af00">length</span><span style="color:#111">;</span><span style="color:#75af00">idx</span><span style="color:#f92672">++</span><span style="color:#111">){</span>
  <span style="color:#00a8c8">let</span> <span style="color:#75af00">item</span> <span style="color:#f92672">=</span> <span style="color:#75af00">keys</span><span style="color:#111">.</span><span style="color:#75af00">items</span><span style="color:#111">[</span><span style="color:#75af00">idx</span><span style="color:#111">];</span>
  <span style="color:#00a8c8">if</span><span style="color:#111">(</span><span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">value</span><span style="color:#f92672">==</span><span style="color:#75af00">apiKey</span><span style="color:#111">){</span>
    <span style="color:#75715e">//found the api key
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">break</span><span style="color:#111">;</span>
  <span style="color:#111">}</span>
<span style="color:#111">}</span>
</code></pre></div><p>So far so good. This provides the name of the key on every request. This is sustainable for small volume APIs, but not for high volume ones. If the API has more invocations, those requests will slow the API down. So introducing some kind of caching would be very helpful.</p>
<p>The API Gateway already has a mechanism that is called before the invocation, which is also capable of caching the results, the Custom Authorizer System.</p>
<p>So I put this code into the custom authorizer to achieve caching and avoid too many queries on the AWS API.</p>
<p>Here is the whole custom authorizer:</p>
<!-- raw HTML omitted -->
<p>After implementing the custom authorizer, key name is propagated throught he Lambda event requestContext object.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75af00">exports</span><span style="color:#111">.</span><span style="color:#75af00">handler</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">async</span> <span style="color:#111">(</span><span style="color:#75af00">event</span><span style="color:#111">,</span> <span style="color:#75af00">context</span><span style="color:#111">)</span> <span style="color:#111">=&gt;</span> <span style="color:#111">{</span>
  <span style="color:#00a8c8">let</span> <span style="color:#75af00">keyname</span> <span style="color:#f92672">=</span> <span style="color:#75af00">event</span><span style="color:#111">.</span><span style="color:#75af00">requestContext</span><span style="color:#111">.</span><span style="color:#75af00">authorizer</span><span style="color:#111">.</span><span style="color:#75af00">apikey</span><span style="color:#111">;</span>
  <span style="color:#00a8c8">return</span> <span style="color:#111">{</span>
    <span style="color:#75af00">statusCode</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">200</span><span style="color:#111">,</span>
    <span style="color:#75af00">body</span><span style="color:#f92672">:</span> <span style="color:#75af00">keyname</span>
  <span style="color:#111">};</span>
<span style="color:#111">}</span>
</code></pre></div>
</div>

        <footer class="post-footer clearfix">
        <p class="post-tags">
            <span>Tagged:</span>
                <a href="/tags/apigateway.html">apigateway</a>, 
                <a href="/tags/lambda.html">lambda</a>
        </p>
    <div class="share">
    </div>
</footer>

        
    </article>
</div>

            </div>
        </div>

        <footer class="footer">
            <div class="container">
                <div class="site-title-wrapper">
                    <h1 class="site-title">
                        <a href="https://jens.dev/">My personal blog</a>
                    </h1>
                    <a class="button-square button-jump-top js-jump-top" href="#" aria-label="Back to Top">
                        <i class="fa fa-angle-up" aria-hidden="true"></i>
                    </a>
                </div>

                <p class="footer-copyright">
                    <span>&copy; 2021 / Powered by <a href="https://gohugo.io/">Hugo</a></span>
                </p>
                <p class="footer-copyright">
                    <span><a href="https://github.com/roryg/ghostwriter">Ghostwriter theme</a> By <a href="http://jollygoodthemes.com">JollyGoodThemes</a></span>
                    <span>/ <a href="https://github.com/jbub/ghostwriter">Ported</a> to Hugo By <a href="https://github.com/jbub">jbub</a></span>
                </p>
            </div>
        </footer>

        <script src="https://jens.dev/js/jquery-1.11.3.min.js"></script>
        <script src="https://jens.dev/js/jquery.fitvids.js"></script>
        <script src="https://jens.dev/js/scripts.js"></script>
    </body>
</html>

