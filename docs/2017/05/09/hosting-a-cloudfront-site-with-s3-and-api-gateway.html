<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>hosting a Cloudfront site with S3 and API Gateway &middot; </title>
        <meta name="description" content="Here my scenario I try to cover this time.
Scenario:
 host a webpage through S3 with Cloudfront as CDN host an API through ApiGateway with Cloudfront in front  As picture this would look like this:
The use case would be to host the API and static resources within one domain. The obvious perk of this architecture would be no more CORS dependency.
I use a CloudFormation template as project definition for this task.">
        <meta name="HandheldFriendly" content="True">
        <meta name="MobileOptimized" content="320">
        <meta name="generator" content="Hugo 0.80.0" />
        <meta name="robots" content="index,follow">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta property="og:title" content="hosting a Cloudfront site with S3 and API Gateway">
<meta property="og:description" content="Here my scenario I try to cover this time.
Scenario:
 host a webpage through S3 with Cloudfront as CDN host an API through ApiGateway with Cloudfront in front  As picture this would look like this:
The use case would be to host the API and static resources within one domain. The obvious perk of this architecture would be no more CORS dependency.
I use a CloudFormation template as project definition for this task.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://jens.dev/2017/05/09/hosting-a-cloudfront-site-with-s3-and-api-gateway.html">
        <link rel="stylesheet" href="https://jens.dev/dist/site.css">
        <link rel="stylesheet" href="https://jens.dev/dist/syntax.css">
        <link rel="icon" type="image/png" href="/favicon.png">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
        
        
        
        
        

    </head>
    <body>
        
<script type="application/javascript">
var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
var doNotTrack = (dnt == "1" || dnt == "yes");
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-5676095-8', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>


        <div id="wrapper">
            <header class="site-header">
                <div class="container">
                    <div class="site-title-wrapper">
                        
                            <h1 class="site-title">
                                <a href="https://jens.dev/">My personal blog</a>
                            </h1>
                        
                        
                            <a class="button-square" href="https://jens.dev/index.xml" aria-label="RSS"><i class="fa fa-rss" aria-hidden="true"></i></a>
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Twitter" aria-label="Twitter" href="https://twitter.com/jens_walter" rel="me" >
                                <i class="fa fa-twitter" aria-hidden="true"></i>
                            </a>
                        
                        
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Github" aria-label="Github" href="https://github.com/JensWalter" rel="me">
                                <i class="fa fa-github-alt" aria-hidden="true"></i>
                            </a>
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Stack Overflow" aria-label="Stack Overflow" href="https://stackoverflow.com/users/story/220219" rel="me">
                                <i class="fa fa-stack-overflow" aria-hidden="true"></i>
                            </a>
                        
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Email" aria-label="Send an Email" href="mailto:jens@apimeister.com">
                                <i class="fa fa-envelope" aria-hidden="true"></i>
                            </a>
                        
                    </div>

                    <ul class="site-nav">
                        
    <li class="site-nav-item">
        <a href="/">Blog</a>
    </li>

    <li class="site-nav-item">
        <a href="/project/">Projects</a>
    </li>


                    </ul>
                </div>
            </header>

            <div id="container">


<div class="container">
    <article class="post-container" itemscope="" itemtype="http://schema.org/BlogPosting">
        <header class="post-header">
    <h1 class="post-title" itemprop="name headline">hosting a Cloudfront site with S3 and API Gateway</h1>
    
    <p class="post-date post-line">
        <span>Published <time datetime="2017-05-09" itemprop="datePublished">Tue, May 9, 2017</time></span>
        <span>by</span>
        <span itemscope="" itemprop="author" itemtype="https://schema.org/Person">
            <span itemprop="name">
                <a href="#" itemprop="url" rel="author"></a>
            </span>
        </span>
    </p>
    
</header>

        <div class="post-content clearfix" itemprop="articleBody">
    

    <p>Here my scenario I try to cover this time.</p>
<p>Scenario:</p>
<ul>
<li>host a webpage through S3 with Cloudfront as CDN</li>
<li>host an API through ApiGateway with Cloudfront in front</li>
</ul>
<p>As picture this would look like this:</p>
<p><img src="/assets/cloudfront-s3-api-gateway.png" alt="timer based event"></p>
<p>The use case would be to host the API and static resources within one domain. The obvious perk of this architecture would be no more CORS dependency.</p>
<p>I use a CloudFormation template as project definition for this task.</p>
<p>So here is my YAML explained step-by-step (whole YAML is attached at the bottom).</p>
<p>I copied the header from an existing template since I have nothing to add here:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">AWSTemplateFormatVersion</span><span style="color:#111">:</span> <span style="color:#d88200">&#39;2010-09-09&#39;</span>
<span style="color:#f92672">Resources</span><span style="color:#111">:</span>
</code></pre></div><p>First I create a S3 bucket to host my page sources.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">webUIBucket</span><span style="color:#111">:</span>
  <span style="color:#f92672">Type</span><span style="color:#111">:</span> <span style="color:#ae81ff">AWS::S3::Bucket</span>
</code></pre></div><p>To host actual content in that bucket, I needed to create a bucket policy which allows public read access on its objects;</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">webUIBucketPolicy</span><span style="color:#111">:</span>
  <span style="color:#f92672">Type</span><span style="color:#111">:</span> <span style="color:#ae81ff">AWS::S3::BucketPolicy</span>
  <span style="color:#f92672">Properties</span><span style="color:#111">:</span>
    <span style="color:#f92672">Bucket</span><span style="color:#111">:</span>
      <span style="color:#f92672">Ref</span><span style="color:#111">:</span> <span style="color:#ae81ff">webUIBucket</span>
    <span style="color:#f92672">PolicyDocument</span><span style="color:#111">:</span>
      <span style="color:#f92672">Version</span><span style="color:#111">:</span> <span style="color:#d88200">2012-10-17</span>
      <span style="color:#f92672">Statement</span><span style="color:#111">:</span>
        - <span style="color:#f92672">Sid</span><span style="color:#111">:</span> <span style="color:#ae81ff">AddPerm</span>
          <span style="color:#f92672">Effect</span><span style="color:#111">:</span> <span style="color:#ae81ff">Allow</span>
          <span style="color:#f92672">Principal</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;*&#34;</span>
          <span style="color:#f92672">Action</span><span style="color:#111">:</span>
            - <span style="color:#d88200">&#34;s3:GetObject&#34;</span>
          <span style="color:#f92672">Resource</span><span style="color:#111">:</span>
            - <span style="color:#f92672">Fn::Join</span><span style="color:#111">:</span>
              - <span style="color:#d88200">&#34;&#34;</span>
              - - <span style="color:#d88200">&#34;arn:aws:s3:::&#34;</span>
                - <span style="color:#f92672">Ref</span><span style="color:#111">:</span> <span style="color:#ae81ff">webUIBucket</span>
                - <span style="color:#d88200">&#34;/*&#34;</span>
</code></pre></div><p>Now I can define the API. In this case I use a sample HelloWorldAPI, just to demonstrate the API gateway setup.</p>
<p>This way, the URL structure would look like this:</p>
<pre><code>https://woouj8k1g5.execute-api.eu-west-1.amazonaws.com/prod/v1/hello
</code></pre><div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">ApiGatewayRestApi</span><span style="color:#111">:</span>
  <span style="color:#f92672">Type</span><span style="color:#111">:</span> <span style="color:#ae81ff">AWS::ApiGateway::RestApi</span>
  <span style="color:#f92672">Properties</span><span style="color:#111">:</span>
    <span style="color:#f92672">Name</span><span style="color:#111">:</span> <span style="color:#ae81ff">hello-api</span>
<span style="color:#f92672">ApiGatewayV1Resource</span><span style="color:#111">:</span>
  <span style="color:#f92672">Type</span><span style="color:#111">:</span> <span style="color:#ae81ff">AWS::ApiGateway::Resource</span>
  <span style="color:#f92672">Properties</span><span style="color:#111">:</span>
    <span style="color:#f92672">ParentId</span><span style="color:#111">:</span>
      <span style="color:#f92672">Fn::GetAtt</span><span style="color:#111">:</span> <span style="color:#111">[</span> <span style="color:#ae81ff">ApiGatewayRestApi , RootResourceId]</span>
    <span style="color:#f92672">PathPart</span><span style="color:#111">:</span> <span style="color:#ae81ff">v1</span>
    <span style="color:#f92672">RestApiId</span><span style="color:#111">:</span> !<span style="color:#ae81ff">Ref ApiGatewayRestApi</span>
<span style="color:#f92672">ApiGatewayHelloResource</span><span style="color:#111">:</span>
  <span style="color:#f92672">Type</span><span style="color:#111">:</span> <span style="color:#ae81ff">AWS::ApiGateway::Resource</span>
  <span style="color:#f92672">Properties</span><span style="color:#111">:</span>
    <span style="color:#f92672">ParentId</span><span style="color:#111">:</span> !<span style="color:#ae81ff">Ref ApiGatewayV1Resource</span>
    <span style="color:#f92672">PathPart</span><span style="color:#111">:</span> <span style="color:#ae81ff">hello</span>
    <span style="color:#f92672">RestApiId</span><span style="color:#111">:</span> !<span style="color:#ae81ff">Ref ApiGatewayRestApi</span>
<span style="color:#f92672">ApiGatewayCreateResourceGetMethod</span><span style="color:#111">:</span>
  <span style="color:#f92672">Type</span><span style="color:#111">:</span> <span style="color:#ae81ff">AWS::ApiGateway::Method</span>
  <span style="color:#f92672">Properties</span><span style="color:#111">:</span>
    <span style="color:#f92672">AuthorizationType</span><span style="color:#111">:</span> <span style="color:#ae81ff">NONE</span>
    <span style="color:#f92672">HttpMethod</span><span style="color:#111">:</span> <span style="color:#ae81ff">GET</span>
    <span style="color:#f92672">Integration</span><span style="color:#111">:</span>
      <span style="color:#f92672">Type</span><span style="color:#111">:</span> <span style="color:#ae81ff">MOCK</span>
      <span style="color:#f92672">RequestTemplates</span><span style="color:#111">:</span>
        <span style="color:#f92672">application/json</span><span style="color:#111">:</span> <span style="color:#d88200">&#39;{&#34;statusCode&#34;:200}&#39;</span>
      <span style="color:#f92672">IntegrationResponses</span><span style="color:#111">:</span>
        - <span style="color:#f92672">StatusCode</span><span style="color:#111">:</span> <span style="color:#ae81ff">200</span>
          <span style="color:#f92672">ResponseTemplates</span><span style="color:#111">:</span>
            <span style="color:#f92672">application/json</span><span style="color:#111">:</span> <span style="color:#d88200">&#39;{&#34;message&#34;:&#34;hello world&#34;}&#39;</span>
    <span style="color:#f92672">MethodResponses</span><span style="color:#111">:</span>
      - <span style="color:#f92672">StatusCode</span><span style="color:#111">:</span> <span style="color:#ae81ff">200</span>
    <span style="color:#f92672">ResourceId</span><span style="color:#111">:</span> !<span style="color:#ae81ff">Ref ApiGatewayHelloResource</span>
    <span style="color:#f92672">RestApiId</span><span style="color:#111">:</span> !<span style="color:#ae81ff">Ref ApiGatewayRestApi</span>
<span style="color:#f92672">ApiGatewayDeployment</span><span style="color:#111">:</span>
  <span style="color:#f92672">Type</span><span style="color:#111">:</span> <span style="color:#ae81ff">AWS::ApiGateway::Deployment</span>
  <span style="color:#f92672">DependsOn</span><span style="color:#111">:</span>
    - <span style="color:#ae81ff">ApiGatewayCreateResourceGetMethod</span>
  <span style="color:#f92672">Properties</span><span style="color:#111">:</span>
    <span style="color:#f92672">RestApiId</span><span style="color:#111">:</span> !<span style="color:#ae81ff">Ref ApiGatewayRestApi</span>
    <span style="color:#f92672">StageName</span><span style="color:#111">:</span> <span style="color:#ae81ff">prod</span>
</code></pre></div><p>Now there comes the juicy part. The Cloudfront configuration is somewhat tricky since API-Gateway requires some adjustments to work.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">WebpageCDN</span><span style="color:#111">:</span>
  <span style="color:#f92672">Type</span><span style="color:#111">:</span> <span style="color:#ae81ff">AWS::CloudFront::Distribution</span>
  <span style="color:#f92672">DependsOn</span><span style="color:#111">:</span> <span style="color:#75715e">#without those explicit depends, the creation just fails</span>
    - <span style="color:#ae81ff">ApiGatewayDeployment</span>
    - <span style="color:#ae81ff">webUIBucket</span>
  <span style="color:#f92672">Properties</span><span style="color:#111">:</span>
    <span style="color:#f92672">DistributionConfig</span><span style="color:#111">:</span>
      <span style="color:#f92672">DefaultCacheBehavior</span><span style="color:#111">:</span> <span style="color:#75715e">#this section defines attached behaviors, first the S3 origin</span>
        <span style="color:#f92672">ForwardedValues</span><span style="color:#111">:</span>
          <span style="color:#f92672">QueryString</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span>
        <span style="color:#f92672">TargetOriginId</span><span style="color:#111">:</span> <span style="color:#ae81ff">webpage</span> <span style="color:#75715e">#name of the origin</span>
        <span style="color:#f92672">ViewerProtocolPolicy</span><span style="color:#111">:</span> <span style="color:#ae81ff">redirect-to-https</span>
      <span style="color:#f92672">CacheBehaviors</span><span style="color:#111">:</span> <span style="color:#75715e">#second the behavior for the API Gateway</span>
        - <span style="color:#f92672">AllowedMethods</span><span style="color:#111">:</span> <span style="color:#75715e">#allow all method for the backend to implement</span>
            - <span style="color:#ae81ff">DELETE</span>
            - <span style="color:#ae81ff">GET</span>
            - <span style="color:#ae81ff">HEAD</span>
            - <span style="color:#ae81ff">OPTIONS</span>
            - <span style="color:#ae81ff">PATCH</span>
            - <span style="color:#ae81ff">POST</span>
            - <span style="color:#ae81ff">PUT</span>
          <span style="color:#f92672">CachedMethods</span><span style="color:#111">:</span> <span style="color:#75715e">#cache only on get requests</span>
            - <span style="color:#ae81ff">GET</span>
            - <span style="color:#ae81ff">HEAD</span>
            - <span style="color:#ae81ff">OPTIONS</span>
          <span style="color:#f92672">Compress</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span>
          <span style="color:#f92672">ForwardedValues</span><span style="color:#111">:</span>
            <span style="color:#f92672">Headers</span><span style="color:#111">:</span> <span style="color:#75715e">#define explicit headers, since API Gateway doesn&#39;t work otherwise</span>
              - <span style="color:#ae81ff">Accept</span>
              - <span style="color:#ae81ff">Referer</span>
              - <span style="color:#ae81ff">Athorization</span>
              - <span style="color:#ae81ff">Content-Type</span>
            <span style="color:#f92672">QueryString</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span> <span style="color:#75715e">#to transfer get parameters to the gateway</span>
          <span style="color:#f92672">PathPattern</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;/v1/*&#34;</span> <span style="color:#75715e">#path pattern after the Gateway stage identifier.</span>
          <span style="color:#f92672">TargetOriginId</span><span style="color:#111">:</span> <span style="color:#ae81ff">api</span> <span style="color:#75715e">#id of the orignin</span>
          <span style="color:#f92672">ViewerProtocolPolicy</span><span style="color:#111">:</span> <span style="color:#ae81ff">https-only</span> <span style="color:#75715e">#API Gateway only support https</span>
      <span style="color:#f92672">DefaultRootObject</span><span style="color:#111">:</span> <span style="color:#ae81ff">index.html</span>
      <span style="color:#f92672">Enabled</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span>
      <span style="color:#f92672">Origins</span><span style="color:#111">:</span>
        - <span style="color:#f92672">DomainName</span><span style="color:#111">:</span> <span style="color:#75715e">#define the s3 origin</span>
            <span style="color:#f92672">Fn::GetAtt</span><span style="color:#111">:</span> <span style="color:#111">[</span> <span style="color:#ae81ff">webUIBucket , &#34;DomainName&#34; ]</span>
          <span style="color:#f92672">Id</span><span style="color:#111">:</span> <span style="color:#ae81ff">webpage</span>
          <span style="color:#f92672">S3OriginConfig</span><span style="color:#111">:</span>
            <span style="color:#f92672">OriginAccessIdentity</span><span style="color:#111">:</span>
              <span style="color:#f92672">Ref</span><span style="color:#111">:</span> <span style="color:#ae81ff">AWS::NoValue</span>
        - <span style="color:#f92672">DomainName</span><span style="color:#111">:</span> <span style="color:#75715e">#define the API Gateway origin</span>
            <span style="color:#f92672">Fn::Join</span><span style="color:#111">:</span>
              - <span style="color:#d88200">&#34;&#34;</span>
              - - <span style="color:#f92672">Ref</span><span style="color:#111">:</span> <span style="color:#ae81ff">ApiGatewayRestApi</span>
                - <span style="color:#d88200">&#34;.execute-api.&#34;</span>
                - <span style="color:#f92672">Ref</span><span style="color:#111">:</span> <span style="color:#ae81ff">AWS::Region</span>
                - <span style="color:#d88200">&#34;.amazonaws.com&#34;</span>
          <span style="color:#f92672">Id</span><span style="color:#111">:</span> <span style="color:#ae81ff">api</span>
          <span style="color:#f92672">CustomOriginConfig</span><span style="color:#111">:</span>
            <span style="color:#f92672">OriginProtocolPolicy</span><span style="color:#111">:</span> <span style="color:#ae81ff">https-only</span> <span style="color:#75715e">#again API-Gateway only supports https</span>
          <span style="color:#f92672">OriginPath</span><span style="color:#111">:</span> <span style="color:#ae81ff">/prod</span> <span style="color:#75715e">#name of the deployed stage</span>
      <span style="color:#f92672">PriceClass</span><span style="color:#111">:</span> <span style="color:#ae81ff">PriceClass_100</span>
</code></pre></div><p>To instantiate this template, just download the file and run the following command:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">aws cloudformation create-stack --stack-name myteststack --template-body file://cf-cloudfront.yml --capabilities CAPABILITY_IAM
</code></pre></div><p>After waiting like forever, you can test your deployment with 2 separate curl commands.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#requesting the S3 bucket (you have to put some actual content into the bucket before calling)</span>
curl https://d25qtz3cn2yuis.cloudfront.net/index.html
hello world.

<span style="color:#75715e">#requesting the API Gateway</span>
curl https://d25qtz3cn2yuis.cloudfront.net/v1/hello
<span style="color:#f92672">{</span><span style="color:#d88200">&#34;message&#34;</span>:<span style="color:#d88200">&#34;hello world&#34;</span><span style="color:#f92672">}</span>
</code></pre></div><p>Here is the overall CloudFormation template:</p>
<p>[cf-cloudfront.yml template][1]</p>
<p>[1]:{{ site.url }}/assets/cf-cloudfront.yml</p>

</div>

        <footer class="post-footer clearfix">
        <p class="post-tags">
            <span>Tagged:</span>
                <a href="/tags/cloudformation/">cloudformation</a>, 
                <a href="/tags/cloudfront/">cloudfront</a>, 
                <a href="/tags/apigateway/">apigateway</a>
        </p>
    <div class="share">
    </div>
</footer>

        
    </article>
</div>

            </div>
        </div>

        <footer class="footer">
            <div class="container">
                <div class="site-title-wrapper">
                    <h1 class="site-title">
                        <a href="https://jens.dev/">My personal blog</a>
                    </h1>
                    <a class="button-square button-jump-top js-jump-top" href="#" aria-label="Back to Top">
                        <i class="fa fa-angle-up" aria-hidden="true"></i>
                    </a>
                </div>

                <p class="footer-copyright">
                    <span>&copy; 2021 / Powered by <a href="https://gohugo.io/">Hugo</a></span>
                </p>
                <p class="footer-copyright">
                    <span><a href="https://github.com/roryg/ghostwriter">Ghostwriter theme</a> By <a href="http://jollygoodthemes.com">JollyGoodThemes</a></span>
                    <span>/ <a href="https://github.com/jbub/ghostwriter">Ported</a> to Hugo By <a href="https://github.com/jbub">jbub</a></span>
                </p>
            </div>
        </footer>

        <script src="https://jens.dev/js/jquery-1.11.3.min.js"></script>
        <script src="https://jens.dev/js/jquery.fitvids.js"></script>
        <script src="https://jens.dev/js/scripts.js"></script>
    </body>
</html>

